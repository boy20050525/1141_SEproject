<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>{{ job["title"] }} - æ¡ˆä»¶è©³æƒ…</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ä¿ç•™æ‚¨åŸæœ¬çš„ CSS */
    * { box-sizing: border-box; font-family: 'Noto Sans TC', sans-serif; }
    body { margin: 0; background-color: #f7f3ef; color: #3b2f2f; line-height: 1.6; }
    header { background-color: #e9dfd0; padding: 20px 40px; text-align: center; border-bottom: 2px solid #d4c7b5; }
    header h2 { margin: 0; font-size: 28px; color: #3e2e1e; }
    main { max-width: 900px; background-color: #fffdfa; margin: 40px auto; padding: 35px 45px; border-radius: 15px; box-shadow: 0 5px 18px rgba(80, 70, 60, 0.15); }
    h3 { border-left: 6px solid #c2a676; padding-left: 12px; font-size: 22px; margin-top: 35px; color: #4b3c2b; }
    p { font-size: 16px; margin-bottom: 8px; }
    a { color: #7a5e3e; text-decoration: none; font-weight: 600; }
    a:hover { text-decoration: underline; color: #5a4632; }
    hr { border: none; border-top: 2px solid #e4d6c4; margin: 30px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; margin-bottom: 25px; background-color: #fffaf3; }
    th, td { padding: 12px 15px; text-align: center; border: 1px solid #e2d5c4; }
    th { background-color: #e9dfd0; }
    input[type="number"], input[type="text"], input[type="file"], textarea { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #cdbda3; margin-top: 6px; }
    button { background-color: #c2a676; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 5px;}
    button:hover { background-color: #a88752; }
    .danger-btn { background-color: #ef4444; }
    .danger-btn:hover { background-color: #c53030; }
    .success-btn { background-color: #10b981; } 
    .success-btn:hover { background-color: #059669; }

    /* Issue Tracker ç‰¹æœ‰æ¨£å¼ */
    .issue-box {
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: #fff;
    }
    .issue-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    .status-tag {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
    }
    .status-open { background-color: #fee2e2; color: #b91c1c; } /* ç´…è‰²æœªè§£æ±º */
    .status-resolved { background-color: #d1fae5; color: #047857; } /* ç¶ è‰²å·²è§£æ±º */
    
    .comment-list { margin-left: 20px; border-left: 3px solid #f3f4f6; padding-left: 15px; }
    .comment-item { margin-bottom: 15px; background-color: #f9fafb; padding: 10px; border-radius: 8px; }
    .comment-meta { font-size: 13px; color: #6b7280; margin-bottom: 5px; }
    .comment-content { color: #1f2937; }
  </style>
</head>

<body>
  <header>
    <h2>{{ job["title"] }}</h2>
  </header>

  <main>
    <p><b>å…§å®¹ï¼š</b> {{ job["content"] }}</p>
    <p><b>ç‹€æ…‹ï¼š</b> 
        <span style="color: #c2a676; font-weight: bold;">{{ job["status"] }}</span>
    </p>
    <p><b>é ç®—ï¼š</b> ${{ job["budget"] }}</p>
    <p><b>å§”è¨—äººï¼š</b> {{ job["client_name"] }}</p>
    <p><b>æ¥æ¡ˆäººï¼š</b> {{ job["freelancer_name"] or "å°šæœªé¸æ“‡" }}</p>
    
    {% if job["requirement_file"] %}
    <p><b>éœ€æ±‚æ–‡ä»¶ï¼š</b>
      <a href="/download_requirement/{{ job['id'] }}" target="_blank">ğŸ“„ ä¸‹è¼‰éœ€æ±‚æª”</a>
    </p>
    {% endif %}

    <hr>

    {% set role = request.session.get("role") %}
    {% set user_id = request.session.get("user_id") %}
    {% set my_username = request.session.get("username") %}

    <p>
      <a href="/">ğŸ  å›é¦–é </a>ã€€
      {% if role == "ç”²æ–¹" %}
        <a href="/dashboard_client">ğŸ“‚ å›æ§åˆ¶å°</a>
      {% elif role == "ä¹™æ–¹" %}
        <a href="/dashboard_freelancer">ğŸ› ï¸ å›æ§åˆ¶å°</a>
      {% endif %}
    </p>

    {% if role == "ä¹™æ–¹" and (job["status"] == "æ–°å·¥ä½œ" or job["status"] == "å¾…ç¢ºèª") %}
    <h3>ğŸ’° æˆ‘è¦å ±åƒ¹</h3>
    <form action="/bid" method="post">
      <input type="hidden" name="job_id" value="{{ job['id'] }}">
      <label>å ±åƒ¹é‡‘é¡ï¼š</label>
      <input type="number" name="amount" min="{{ job['budget'] }}" required>
      <button type="submit">ğŸ“¤ é€å‡ºå ±åƒ¹</button>
    </form>
    {% endif %}

    {% if (role == "ç”²æ–¹" or role == "ä¹™æ–¹") and (job["status"] == "æ–°å·¥ä½œ" or job["status"] == "å¾…ç¢ºèª") %}
        {% if bids %}
        <h3>ğŸ“Š å ±åƒ¹ç´€éŒ„</h3>
        <table>
        <tr><th>ä¹™æ–¹</th><th>é‡‘é¡</th><th>æ™‚é–“</th>{% if role == "ç”²æ–¹" %}<th>æ“ä½œ</th>{% endif %}</tr>
        {% for bid in bids %}
        <tr>
            <td>{{ bid["username"] }}</td>
            <td>${{ bid["amount"] }}</td>
            <td>{{ bid["created_at"] }}</td>
            {% if role == "ç”²æ–¹" %}
            <td>
            <form action="/chooseBid" method="post">
                <input type="hidden" name="job_id" value="{{ job['id'] }}">
                <input type="hidden" name="freelancer_id" value="{{ bid['bidder_id'] }}">
                <button type="submit">âœ… é¸æ“‡æ­¤äºº</button>
            </form>
            </td>
            {% endif %}
        </tr>
        {% endfor %}
        </table>
        {% endif %}
    {% endif %}


    {% if job["status"] in ["ä¸Šå‚³æˆæœ", "å·²å®Œæˆ"] %}
        <h3>ğŸ“¦ æˆæœäº¤ä»˜</h3>
        <div style="background:#fdf6e3; padding:15px; border-radius:8px; border:1px solid #eee8d5;">
            <p><b>æœ€æ–°ä¸Šå‚³æ™‚é–“ï¼š</b> {{ deliverable["uploaded_at"] if deliverable else "æœªçŸ¥" }}</p>
            <p>
                <a href="/download/{{ job['id'] }}" style="font-size:18px;">ğŸ“¥ ä¸‹è¼‰ä¹™æ–¹äº¤ä»˜çš„æª”æ¡ˆ</a>
            </p>
        </div>
    {% endif %}

    {% if role == "ä¹™æ–¹" and (job["status"] == "é€²è¡Œä¸­" or job["status"] == "ä¸Šå‚³æˆæœ") and job["freelancer_name"] == my_username %}
        <h3>ğŸ“¤ ä¸Šå‚³/æ›´æ–°æˆæœ</h3>
        <form action="/api/upload" method="post" enctype="multipart/form-data">
            <input type="hidden" name="job_id" value="{{ job['id'] }}">
            <input type="file" name="uploadedFile" required>
            <button type="submit">ğŸš€ ä¸Šå‚³æª”æ¡ˆ (é€™å°‡æ›´æ–°æ¡ˆä»¶ç‹€æ…‹)</button>
        </form>
    {% endif %}


    {% if job["status"] in ["ä¸Šå‚³æˆæœ", "å·²å®Œæˆ"] %}
        
        <h3 style="border-left-color: #ef4444;">ğŸ å•é¡Œè¿½è¹¤ (Issue Tracker)</h3>
        
        {% if issues %}
            {% for issue in issues %}
            <div class="issue-box" style="{{ 'border-color:#10b981;' if issue['status']=='å·²è§£æ±º' else 'border-color:#fca5a5;' }}">
                <div class="issue-header">
                    <div>
                        <span class="status-tag {{ 'status-resolved' if issue['status']=='å·²è§£æ±º' else 'status-open' }}">
                            {{ issue['status'] }}
                        </span>
                        <strong style="font-size:18px; margin-left:8px;">{{ issue['title'] }}</strong>
                        <div style="font-size:13px; color:#888; margin-top:4px;">
                            ç”± {{ issue['creator_name'] }} å»ºç«‹æ–¼ {{ issue['created_at'] }}
                        </div>
                    </div>
                    
                    {% if role == "ç”²æ–¹" and issue['status'] == 'æœªè§£æ±º' %}
                    <form action="/api/resolveIssue" method="post">
                        <input type="hidden" name="job_id" value="{{ job['id'] }}">
                        <input type="hidden" name="issue_id" value="{{ issue['id'] }}">
                        <button type="submit" class="success-btn">âœ¨ æ¨™è¨˜ç‚ºå·²è§£æ±º</button>
                    </form>
                    {% endif %}
                </div>

                <div class="comment-list">
                    {% for comment in issue["comments"] %}
                    <div class="comment-item">
                        <div class="comment-meta">
                            <b>{{ comment["username"] }} ({{ comment["role"] }})</b> 
                            <span> â€¢ {{ comment["created_at"] }}</span>
                        </div>
                        <div class="comment-content">{{ comment["content"] }}</div>
                    </div>
                    {% endfor %}
                </div>

                {% if issue['status'] == 'æœªè§£æ±º' and (role == "ç”²æ–¹" or (role == "ä¹™æ–¹" and job["freelancer_name"] == my_username)) %}
                <form action="/api/addComment" method="post" style="margin-top:15px; display:flex; gap:10px;">
                    <input type="hidden" name="job_id" value="{{ job['id'] }}">
                    <input type="hidden" name="issue_id" value="{{ issue['id'] }}">
                    <input type="text" name="content" placeholder="è¼¸å…¥å›è¦†..." required style="margin-top:0; flex-grow:1;">
                    <button type="submit" style="margin-top:0; padding:8px 15px;">ğŸ’¬ å›è¦†</button>
                </form>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <p style="color:#666;">ç›®å‰æ²’æœ‰ä»»ä½•å¾…è§£æ±ºäº‹é …ã€‚</p>
        {% endif %}

        {% if role == "ç”²æ–¹" and job["status"] != "å·²å®Œæˆ" %}
        <div style="background-color:#fff3cd; padding:15px; border-radius:10px; margin-top:20px;">
            <h4 style="margin-top:0; color:#856404;">ğŸ“ æ–°å¢å¾…è§£æ±ºäº‹é … (Issue)</h4>
            <form action="/api/addIssue" method="post">
                <input type="hidden" name="job_id" value="{{ job['id'] }}">
                <input type="text" name="title" placeholder="è«‹ç°¡è¿°å•é¡Œ (ä¾‹å¦‚ï¼šLogo é¡è‰²éœ€èª¿æ•´...)" required>
                <button type="submit" style="background-color:#e0a800;">â• å»ºç«‹ Issue</button>
            </form>
        </div>
        {% endif %}

    {% endif %}


    {% if role == "ç”²æ–¹" and job["status"] == "ä¸Šå‚³æˆæœ" %}
        <hr>
        <div style="text-align:center; margin-top:30px;">
            <h3>ğŸ å°ˆæ¡ˆçµæ¡ˆ</h3>
            <p>è«‹ç¢ºèªæ‰€æœ‰ Issue çš†å·²æ¨™è¨˜ç‚ºã€Œå·²è§£æ±ºã€å¾Œï¼Œæ‰å¯é»æ“Šçµæ¡ˆã€‚</p>
            
            <form action="/completeJob" method="post">
                <input type="hidden" name="job_id" value="{{ job['id'] }}">
                <button type="submit" class="success-btn" style="padding:15px 30px; font-size:18px;">ğŸ‰ ç¢ºèªå°ˆæ¡ˆé©—æ”¶å®Œæˆ (çµæ¡ˆ)</button>
            </form>
        </div>
    {% endif %}

    {% if job["status"] == "å·²å®Œæˆ" %}
    <hr>
    <div style="text-align:center; color:green; padding:20px; background:#e6fffa; border-radius:10px;">
        <h2>âœ… æ¡ˆä»¶åœ“æ»¿çµæ¡ˆï¼</h2>
        <p>æ„Ÿè¬é›™æ–¹çš„åˆä½œã€‚</p>
    </div>
    {% endif %}

  </main>

  <footer>Â© 2025 å·¥ä½œå§”è¨—å¹³å° | æ¡ˆä»¶è©³æƒ…é </footer>
</body>
</html>